# Paste Stabilizer Configuration
# This file defines all parameters for reproducible experiments

# Experimental Protocol
experiment:
  min_trials: 10          # Minimum N=10, better N=20
  baseline_trials: 10
  stabilized_trials: 10
  electrical_trials: 10
  
  # Paste preparation protocol
  paste_prep:
    de_airing: true
    sieving: true
    loading_method: "syringe"  # or "cartridge"
  
  # Nozzle selection
  nozzle_diameter_mm: 0.4
  particle_size_ratio: 0.3  # particle_size / nozzle_diameter should be < 0.3
  
  # First layer settings
  first_layer_gap_mm: 0.1
  first_layer_gap_range: [0.08, 0.12]
  
  # Prime + purge routine
  prime:
    total_e: 8.0
    steps: 8
    feed_mm_min: 120.0
  
  purge:
    x0: 10.0
    y0: 10.0
    x1: 80.0
    y1: 10.0
    z: 1.2
    e: 12.0
    feed_xy_mm_min: 600.0
    feed_e_mm_min: 180.0
  
  # Retraction policy
  retraction:
    suppressed: true
    dwell_s: 0.35
    micro_prime_e: 0.6
    micro_prime_feed_mm_min: 120.0
  
  # Recovery routine
  recovery:
    dwell_s: 0.30
    purge_e: 0.6
    purge_feed_mm_min: 120.0
    max_attempts: 3

# Stabilizer Control Parameters
stabilizer:
  # Sampling rate
  sample_rate_hz: 5.0
  Ts: 0.20  # 1 / sample_rate_hz
  
  # Pressure estimator
  alpha: 8.0
  tau_r: 6.0
  p_y: 5.0      # yield threshold
  p_max: 14.0  # upper safe bound
  
  # u proxy and shaping
  u_scale: 1.0
  du_max: 0.35  # max change in u per step
  
  # Pressure relaxation
  relax_dwell_s: 0.30
  relax_trigger_margin: 0.5
  
  # Low pressure priming
  lowprime_e: 0.6
  lowprime_feed_mm_min: 120.0
  lowprime_steps_max: 3
  
  # Feed scaling limits
  feed_scale_min: 0.5
  feed_scale_max: 1.5

# Sensor Configuration
sensors:
  enabled: true
  
  # Force sensor (HX711 + load cell)
  force:
    enabled: true
    pin_dout: 5
    pin_sck: 6
    sample_rate_hz: 10.0
    calibration_factor: 1.0  # Calibrate with known weights
    baseline_samples: 100  # For computing mu_F, sigma_F
    baseline_duration_s: 20.0
    
    # Stall detection thresholds
    overpressure_k_sigma: 3.0
    low_force_threshold: 0.1  # N
  
  # Environmental sensor (DHT22)
  environment:
    enabled: true
    pin: 4
    sensor_type: "DHT22"  # or "AM2302"
    sample_rate_hz: 0.5
    
  # Optional: Encoder (extruder step detection)
  encoder:
    enabled: false
    pin_a: 2
    pin_b: 3
    steps_per_rev: 200
    
  # Optional: Camera (flow continuity)
  camera:
    enabled: false
    device_id: 0
    fps: 10
    resolution: [640, 480]

# Serial Communication
serial:
  port: "/dev/ttyUSB0"  # Adjust for your system
  baudrate: 115200
  timeout: 1.0
  write_timeout: 1.0

# Data Logging
logging:
  # Time sync
  timebase: "monotonic"  # Use monotonic clock
  
  # Log formats
  raw_sensors: true
  resampled_sensors: true
  events: true
  serial_rx_tx: true
  
  # File formats
  use_parquet: false  # Set to true for better performance with large datasets
  csv_compression: false

# Analysis and Plotting
analysis:
  # Metrics computation
  compute_metrics: true
  
  # Plot generation
  dpi: 300
  figure_format: "png"
  
  # Statistical reporting
  bootstrap_samples: 1000
  confidence_level: 0.95

# Paper Integration
paper:
  figures_dir: "paper/figures"
  tables_dir: "paper/tables"
  
  # Fixed figure filenames (for LaTeX)
  figures:
    extrusion_time_plot: "extrusion_time_plot.png"
    first_layer_success: "first_layer_success.png"
    completion_rate: "completion_rate.png"
    clog_frequency: "clog_frequency.png"
    force_trace_examples: "force_trace_examples.png"
    force_distribution: "force_distribution.png"
    pressure_estimate: "pressure_estimate.png"
    electrical_results: "electrical_results.png"
    timeline_events: "timeline_events.png"
